<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S√ºper Okuma Macerasƒ±</title>
    <!-- Comic Neue: Disleksi dostu font -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Open+Sans:wght@800&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #E3F2FD; 
            font-family: 'Comic Neue', cursive; 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none; 
        }
        canvas { display: block; width: 100%; height: 100%; }
        .hidden { display: none !important; }

        /* UI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; z-index: 10; }
        
        #top-bar { display: flex; justify-content: space-between; padding: 15px; width: 100%; box-sizing: border-box; }
        
        .game-btn { 
            pointer-events: auto; background: #fff; border: 3px solid #333; color: #333; 
            padding: 10px 20px; border-radius: 15px; font-weight: 900; font-size: 18px; 
            cursor: pointer; font-family: 'Comic Neue', cursive; box-shadow: 0 5px 0 rgba(0,0,0,0.2);
        }
        .game-btn:active { transform: translateY(4px); box-shadow: none; }

        #question-panel { 
            align-self: center; background: #FFF9C4; border: 5px solid #222; 
            border-radius: 20px; padding: 20px 40px; text-align: center; margin-top: 10px; 
            pointer-events: auto; min-width: 400px; box-shadow: 0 10px 0 rgba(0,0,0,0.1);
        }
        
        #question-cat { color: #E65100; font-weight: 900; font-size: 18px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
        #question-text { font-size: 36px; font-weight: 900; margin: 5px 0; color: #212121; letter-spacing: 2px; line-height: 1.4; }
        .reading-ruler { width: 100%; height: 5px; background: rgba(0,0,0,0.1); margin-top: 5px; border-radius: 5px; }

        #stats-panel { background: #fff; color: #333; padding: 10px 25px; border-radius: 20px; border: 4px solid #FFD700; font-weight: 900; font-size: 24px; }

        /* KONTROLLER */
        #visual-controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 50px; pointer-events: none; box-sizing: border-box; }
        .control-cluster { display: flex; gap: 30px; pointer-events: auto; }
        .control-btn { width: 90px; height: 90px; border-radius: 25px; background: #fff; border-bottom: 8px solid #999; color: #333; font-size: 30px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .control-btn:active { transform: translateY(8px); border-bottom: 0; background: #eee; }
        #btn-fire { background: #FFCDD2; border-color: #E57373; color: #D32F2F; }
        #btn-jump { background: #C8E6C9; border-color: #81C784; color: #2E7D32; }

        /* MEN√úLER */
        #overlay, #shop-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(33,33,33,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; pointer-events: auto; color: white; text-align: center; }
        #shop-modal { display: none; background: #F5F5F5; color: #333; }
        
        .level-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px; }
        .level-btn { background: #FAFAFA; color: #333; border: 4px solid #eee; padding: 20px; border-radius: 20px; cursor: pointer; font-size: 20px; font-weight: bold; font-family: 'Comic Neue'; }
        .level-btn.selected { background: #A5D6A7; border-color: #4CAF50; transform: scale(1.05); }
        .level-desc { display: block; font-size: 14px; margin-top: 5px; color: #666; font-weight: normal; }

        #main-action-btn { background: #FF7043; color: white; border: none; padding: 20px 60px; font-size: 28px; border-radius: 40px; cursor: pointer; font-weight: 900; margin-top: 20px; box-shadow: 0 8px 0 #D84315; letter-spacing: 2px; font-family: 'Comic Neue'; }
        #main-action-btn:active { transform: translateY(8px); box-shadow: none; }

        /* MAƒûAZA */
        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 800px; padding: 20px; }
        .shop-item { background: #fff; border: 3px solid #eee; border-radius: 15px; padding: 15px; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .shop-item.owned { border-color: #81C784; background: #E8F5E9; }
        .shop-item.equipped { border-color: #FFD700; background: #FFFDE7; border-width: 5px; }
        
        @media (max-width: 800px) { 
            #question-text { font-size: 24px; } 
            #question-panel { min-width: auto; width: 90%; }
            .level-grid { grid-template-columns: 1fr; }
            .shop-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="top-bar">
        <button class="game-btn" onclick="openShop()">ü¶∏ KOST√úMLER</button>
        <button class="game-btn" style="background:#B3E5FC; border-color:#039BE5;" onclick="speakQuestion()">üîä Dƒ∞NLE</button>
        <div id="stats-panel">‚≠ê <span id="score">0</span></div>
    </div>
    <div id="question-panel">
        <div id="question-cat">HAZIRLAN...</div>
        <div id="question-text">Okuma Macerasƒ±</div>
        <div class="reading-ruler"></div>
    </div>
</div>

<div id="visual-controls">
    <div class="control-cluster">
        <div class="control-btn" id="btn-left">SOL</div>
        <div class="control-btn" id="btn-right">SAƒû</div>
    </div>
    <div class="control-cluster">
        <div class="control-btn" id="btn-jump">ZIPLA</div>
        <div class="control-btn" id="btn-fire">AT</div>
    </div>
</div>

<div id="shop-modal">
    <h2 style="font-size:32px;">KAHRAMANINI SE√á</h2>
    <div style="font-size:20px; font-weight:bold; margin-bottom:10px;">PUANIN: <span id="shop-balance">0</span> ‚≠ê</div>
    <div class="shop-grid" id="shop-items"></div>
    <button class="game-btn" style="background:#EF5350; border-color:#B71C1C; color:white;" onclick="closeShop()">KAPAT</button>
</div>

<div id="overlay">
    <h1 id="menu-title" style="font-size: 48px; margin-bottom: 10px; color:#FFCA28; text-shadow: 2px 2px 0 #333;">S√úPER KAHRAMANLAR</h1>
    <p id="menu-desc" style="font-size: 20px; margin-bottom: 20px;">Hangi harfleri √ßalƒ±≈üalƒ±m?</p>
    
    <div class="level-grid" id="level-selection">
        <button class="level-btn selected" onclick="selLvl(0)">1. G√ñREV<br><span class="level-desc">b - d - p (Harf)</span></button>
        <button class="level-btn" onclick="selLvl(1)">2. G√ñREV<br><span class="level-desc">Doƒüru Yazƒ±m</span></button>
        <button class="level-btn" onclick="selLvl(2)">3. G√ñREV<br><span class="level-desc">E≈ü Anlamlƒ±lar</span></button>
        <button class="level-btn" onclick="selLvl(3)">4. G√ñREV<br><span class="level-desc">Mantƒ±k</span></button>
    </div>
    
    <button id="main-action-btn" onclick="startGame()">OYUNA BA≈ûLA üöÄ</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
// --- VERƒ∞LER ---
const LEVELS = [
    [ {c:"HARFƒ∞ BUL", q:"b harfi hangisi?", o:["b","d","p","q"], a:"b"}, {c:"HARFƒ∞ BUL", q:"d harfi hangisi?", o:["d","b","g","p"], a:"d"}, {c:"OKU", q:"baba", o:["baba","dada","papa","bada"], a:"baba"}, {c:"OKU", q:"dede", o:["dede","bebe","pede","bede"], a:"dede"} ],
    [ {c:"Dƒ∞KKAT", q:"Hangisi doƒüru?", o:["herkes","herkez","harkes","herks"], a:"herkes"}, {c:"Dƒ∞KKAT", q:"Hangisi doƒüru?", o:["yalnƒ±z","yanlƒ±z","yalnƒ±s","yanlz"], a:"yalnƒ±z"}, {c:"Dƒ∞KKAT", q:"Hangisi doƒüru?", o:["≈üof√∂r","≈ü√∂f√∂r","sof√∂r","≈üofer"], a:"≈üof√∂r"} ],
    [ {c:"KELƒ∞ME", q:"Siyah e≈ü anlamlƒ±sƒ±?", o:["Kara","Ak","Beyaz","Al"], a:"Kara"}, {c:"KELƒ∞ME", q:"Mektep e≈ü anlamlƒ±sƒ±?", o:["Okul","Ev","Sƒ±nƒ±f","Yol"], a:"Okul"}, {c:"KELƒ∞ME", q:"Zengin zƒ±t anlamlƒ±sƒ±?", o:["Fakir","Varlƒ±klƒ±","G√º√ßl√º","Bol"], a:"Fakir"} ],
    [ {c:"MANTIK", q:"G√ºne≈ü doƒüunca ___ olur.", o:["g√ºnd√ºz","gece","karanlƒ±k","ak≈üam"], a:"g√ºnd√ºz"}, {c:"MANTIK", q:"Balƒ±klar ___ ya≈üar.", o:["suda","karada","havada","uzayda"], a:"suda"}, {c:"C√úMLE", q:"Eve geldim ___ yoktu.", o:["ama","ve","ile","√ß√ºnk√º"], a:"ama"} ]
];

const HEROES = [
    { id: 'h_spider', name: '√ñr√ºmcek', price: 0, color: '#D32F2F', type: 'spider' },
    { id: 'h_bat', name: 'Yarasa', price: 50, color: '#263238', type: 'bat' },
    { id: 'h_iron', name: 'Demir', price: 100, color: '#BF360C', type: 'iron' },
    { id: 'h_super', name: 'S√ºper', price: 150, color: '#1976D2', type: 'super' },
    { id: 'h_green', name: 'Ye≈üil Dev', price: 200, color: '#388E3C', type: 'hulk' }
];

// --- SES Sƒ∞STEMƒ∞ ---
const SFX = {
    ctx: null,
    init: function() { try { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if(this.ctx.state==='suspended') this.ctx.resume(); } catch(e){} },
    play: function(f,t) { if(!this.ctx) return; try{ const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.type=t; o.frequency.value=f; g.gain.setValueAtTime(0.1, this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+0.15); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.15); }catch(e){} }
};

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        // V10 Kayƒ±t
        try { this.data = JSON.parse(localStorage.getItem('hero_v10')) || {sc:0, unl:['h_spider'], cur:'h_spider'}; } catch { this.data = {sc:0, unl:['h_spider'], cur:'h_spider'}; }
        
        this.player = {x:100, y:300, vx:0, vy:0, w:45, h:75, face:1, frame:0, jumpCount:0};
        this.camX = 0;
        this.active = false;
        this.blocks = [];
        this.input = {l:0, r:0, j:0};
        this.clouds = Array(15).fill(0).map(()=>({x:Math.random()*2000, y:Math.random()*300, s:0.3+Math.random()*0.5}));
        this.particles = [];

        this.resize();
        window.addEventListener('resize', ()=>this.resize());
        this.setupInput();
        
        const loop = () => { this.update(); this.draw(); requestAnimationFrame(loop); };
        requestAnimationFrame(loop);
    }

    resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; }
    save() { localStorage.setItem('hero_v10', JSON.stringify(this.data)); }

    start(lvl) {
        this.active = true;
        this.player.x = 200; this.player.y = 200; this.player.vx = 0; this.player.vy = 0;
        this.blocks = []; this.bullets = []; this.particles = [];
        const qList = LEVELS[lvl] || LEVELS[0];
        
        // Zemin
        for(let i=-2; i<100; i++) this.blocks.push({t:'g', x:i*400, y:500, w:400, h:300});
        
        let cx = 700;
        qList.forEach(q => {
            this.blocks.push({t:'trig', x:cx, y:0, w:50, h:1000, q:q});
            const o = [...q.o].sort(()=>Math.random()-0.5);
            // Kutular (Al√ßak)
            this.blocks.push({t:'box', x:cx, y:420, w:110, h:80, val:o[0], ok:o[0]===q.a});
            this.blocks.push({t:'box', x:cx+150, y:300, w:110, h:80, val:o[1], ok:o[1]===q.a});
            this.blocks.push({t:'box', x:cx+300, y:300, w:110, h:80, val:o[2], ok:o[2]===q.a});
            this.blocks.push({t:'box', x:cx+450, y:420, w:110, h:80, val:o[3], ok:o[3]===q.a});
            this.blocks.push({t:'star', x:cx+225, y:200, w:40, h:40});
            cx += 1200;
        });
        
        this.goalX = cx;
        this.blocks.push({t:'fin', x:cx, y:200, w:60, h:300});
        
        document.getElementById('score').innerText = this.data.sc;
        document.getElementById('overlay').classList.add('hidden');
        SFX.init();
    }

    update() {
        if(!this.active) return;
        
        if(this.input.r) { this.player.vx = 7; this.player.face = 1; this.player.frame+=0.2; }
        else if(this.input.l) { this.player.vx = -7; this.player.face = -1; this.player.frame+=0.2; }
        else { this.player.vx *= 0.8; this.player.frame = 0; }
        
        if(this.input.j) {
            if(this.player.grounded || this.player.jumpCount < 2) { 
                this.player.vy = -20; this.player.jumpCount++; this.player.grounded = false; 
                SFX.play(300+(this.player.jumpCount*100), 'square');
            }
            this.input.j = 0;
        }
        
        this.player.vy += 0.8; 
        this.player.x += this.player.vx; 
        this.collide(1,0); 
        this.player.y += this.player.vy; 
        this.player.grounded = false; 
        this.collide(0,1);
        if(this.player.grounded) this.player.jumpCount = 0;

        if(this.player.y > 1000 || isNaN(this.player.y)) { this.player.y = 200; this.player.x = Math.max(0, this.player.x-300); this.player.vy = 0; }
        this.camX += (this.player.x - 250 - this.camX) * 0.1;
        
        // Mermiler
        if(this.bullets) {
            for(let i=this.bullets.length-1; i>=0; i--) {
                let b = this.bullets[i]; b.x+=b.vx; b.life--;
                if(b.life<=0) this.bullets.splice(i,1);
                else {
                    for(let k of this.blocks) {
                        if(k.t==='box' && !k.hit && b.x>k.x && b.x<k.x+k.w && b.y>k.y && b.y<k.y+k.h) {
                            k.hit = true; this.bullets.splice(i,1);
                            this.spawnParticles(k.x+k.w/2, k.y+k.h/2, k.ok?'#4CAF50':'#F44336');
                            if(k.ok) {
                                this.data.sc += 20; this.save();
                                document.getElementById('question-panel').style.borderColor = "#4CAF50";
                                document.getElementById('question-panel').style.backgroundColor = "#E8F5E9";
                                document.getElementById('score').innerText = this.data.sc;
                                SFX.play(600, 'sine');
                            } else {
                                document.getElementById('question-panel').style.borderColor = "#F44336";
                                document.getElementById('question-panel').style.backgroundColor = "#FFEBEE";
                                SFX.play(150, 'sawtooth');
                            }
                            setTimeout(()=> { document.getElementById('question-panel').style.borderColor = "#333"; document.getElementById('question-panel').style.backgroundColor = "#FFF9C4"; }, 500);
                            break;
                        }
                    }
                }
            }
        }
        
        // Tetikleyiciler
        for(let i=this.blocks.length-1; i>=0; i--) {
            let b = this.blocks[i];
            if(b.t==='trig' && Math.abs(this.player.x - b.x) < 400) {
                if(document.getElementById('question-text').innerText !== b.q.q) {
                    document.getElementById('question-cat').innerText = b.q.c;
                    document.getElementById('question-text').innerText = b.q.q;
                }
            }
            if(b.t==='star' && !b.hit && Math.abs(this.player.x - b.x) < 60 && Math.abs(this.player.y - b.y) < 60) {
                b.hit = true; this.data.sc += 5; this.save();
                this.spawnParticles(b.x, b.y, '#FFD700');
                document.getElementById('score').innerText = this.data.sc;
                SFX.play(1000, 'triangle');
            }
            if(b.t==='fin' && Math.abs(this.player.x - b.x) < 50) {
                this.active = false;
                this.spawnParticles(this.player.x, this.player.y, '#fff', 50);
                handleLevelComplete();
                SFX.play(500, 'square'); SFX.play(700, 'square');
            }
        }

        // Par√ßacƒ±klar
        for(let i=this.particles.length-1; i>=0; i--) {
            let p = this.particles[i]; p.x+=p.vx; p.y+=p.vy; p.l-=0.05;
            if(p.l<=0) this.particles.splice(i,1);
        }
    }

    spawnParticles(x, y, c, count=10) {
        for(let i=0; i<count; i++) this.particles.push({x:x, y:y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, c:c, l:1});
    }

    collide(dx, dy) {
        for(let b of this.blocks) {
            if(b.t!=='g') continue;
            if(this.player.x+20 > b.x && this.player.x-20 < b.x+b.w && this.player.y > b.y && this.player.y-this.player.h < b.y+b.h) {
                if(dy) { if(this.player.vy > 0) { this.player.y = b.y; this.player.grounded = true; this.player.vy = 0; } else { this.player.y = b.y+b.h+this.player.h; this.player.vy = 0; } }
                else if(dx) { if(this.player.vx > 0) this.player.x = b.x-20; else this.player.x = b.x+b.w+20; this.player.vx = 0; }
            }
        }
    }

    draw() {
        this.ctx.fillStyle = '#E3F2FD'; this.ctx.fillRect(0,0,this.canvas.width, this.canvas.height);
        this.clouds.forEach(c => { c.x-=c.s; if(c.x<-200)c.x=this.canvas.width+200; this.ctx.fillStyle='rgba(255,255,255,0.8)'; this.ctx.beginPath(); this.ctx.arc(c.x, c.y, 40, 0, Math.PI*2); this.ctx.fill(); this.ctx.beginPath(); this.ctx.arc(c.x+50, c.y+10, 50, 0, Math.PI*2); this.ctx.fill(); });

        this.ctx.save();
        this.ctx.translate(-this.camX, 0);

        for(let b of this.blocks) {
            if(b.t==='g') { this.ctx.fillStyle = '#81C784'; this.ctx.fillRect(b.x, b.y, b.w, b.h); this.ctx.fillStyle = '#66BB6A'; this.ctx.fillRect(b.x, b.y, b.w, 10); }
            else if(b.t==='box' && !b.hit) { this.ctx.fillStyle = '#fff'; this.ctx.fillRect(b.x, b.y, b.w, b.h); this.ctx.lineWidth = 4; this.ctx.strokeStyle = '#333'; this.ctx.strokeRect(b.x, b.y, b.w, b.h); this.ctx.fillStyle = '#000'; this.ctx.font = 'bold 24px "Comic Neue"'; this.ctx.textAlign='center'; this.ctx.fillText(b.val, b.x+b.w/2, b.y+b.h/2+10); }
            else if(b.t==='star' && !b.hit) { this.ctx.fillStyle = '#FFD700'; this.ctx.beginPath(); this.ctx.arc(b.x+20, b.y+20, 15, 0, Math.PI*2); this.ctx.fill(); }
            else if(b.t==='fin') { this.ctx.fillStyle = '#D32F2F'; this.ctx.fillRect(b.x, b.y, 10, 300); this.ctx.fillStyle = '#fff'; this.ctx.fillRect(b.x, b.y, 80, 50); this.ctx.fillStyle = '#D32F2F'; this.ctx.font='bold 20px sans-serif'; this.ctx.fillText("Bƒ∞Tƒ∞≈û", b.x+40, b.y+30); }
        }

        if(this.bullets) { this.ctx.fillStyle = '#FF7043'; this.bullets.forEach(b => { this.ctx.beginPath(); this.ctx.arc(b.x, b.y, 10, 0, Math.PI*2); this.ctx.fill(); }); }
        this.drawHero();
        this.particles.forEach(p => { this.ctx.globalAlpha=p.l; this.ctx.fillStyle=p.c; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 5, 0, Math.PI*2); this.ctx.fill(); this.ctx.globalAlpha=1; });
        this.ctx.restore();
    }

    drawHero() {
        const p = this.player;
        const hid = this.data.cur;
        const char = HEROES.find(h=>h.id===hid) || HEROES[0];
        
        this.ctx.save();
        this.ctx.translate(p.x, p.y);
        this.ctx.scale(p.face, 1);
        const b = Math.sin(p.frame)*5; 
        
        this.ctx.fillStyle = (char.type==='bat') ? 'black' : '#D32F2F';
        if(char.type!=='spider' && char.type!=='hulk') { this.ctx.beginPath(); this.ctx.moveTo(-10,-60); this.ctx.lineTo(-30-Math.abs(b), -10); this.ctx.lineTo(-5, -10); this.ctx.fill(); }

        this.ctx.fillStyle = char.color; this.ctx.fillRect(-15, -55, 30, 35); 
        this.ctx.fillStyle = (char.type==='super') ? '#1565C0' : char.color; 
        if(char.type==='hulk') this.ctx.fillStyle = '#5E35B1'; 
        this.ctx.fillRect(-12, -25, 10, 25); this.ctx.fillRect(2, -25+b, 10, 25);

        this.ctx.fillStyle = char.color;
        if(char.type==='super') this.ctx.fillStyle = '#FFCC80';
        this.ctx.beginPath(); this.ctx.arc(0, -65, 15, 0, Math.PI*2); this.ctx.fill();

        if(char.type==='spider') { this.ctx.fillStyle='white'; this.ctx.beginPath(); this.ctx.ellipse(5,-65, 5,7, -0.3, 0, Math.PI*2); this.ctx.fill(); }
        else if(char.type==='bat') { this.ctx.fillStyle='black'; this.ctx.beginPath(); this.ctx.moveTo(-10,-75); this.ctx.lineTo(-12,-90); this.ctx.lineTo(0,-78); this.ctx.lineTo(12,-90); this.ctx.lineTo(10,-75); this.ctx.fill(); this.ctx.fillStyle='white'; this.ctx.fillRect(2,-68,8,3); }
        else if(char.type==='iron') { this.ctx.fillStyle='#FDD835'; this.ctx.fillRect(-10,-75,20,20); this.ctx.fillStyle='#4FC3F7'; this.ctx.beginPath(); this.ctx.arc(0,-45,5,0,Math.PI*2); this.ctx.fill(); }

        this.ctx.fillStyle = char.color; this.ctx.fillRect(5, -45, 20, 8);
        this.ctx.restore();
    }

    setupInput() {
        const set = (k, v) => this.input[k] = v;
        window.onkeydown = e => { if(e.key==='ArrowRight') set('r',1); if(e.key==='ArrowLeft') set('l',1); if(e.key==='ArrowUp'||e.code==='Space') set('j',1); if(e.key==='f') this.fire(); };
        window.onkeyup = e => { if(e.key==='ArrowRight') set('r',0); if(e.key==='ArrowLeft') set('l',0); if(e.key==='ArrowUp'||e.code==='Space') set('j',0); };
        const touch = (id, k) => {
            const el = document.getElementById(id);
            el.ontouchstart = el.onmousedown = (e) => { e.preventDefault(); if(k==='f') this.fire(); else set(k,1); el.style.transform="scale(0.9)"; };
            el.ontouchend = el.onmouseup = (e) => { e.preventDefault(); if(k!=='f') set(k,0); el.style.transform="scale(1)"; };
        };
        touch('btn-left','l'); touch('btn-right','r'); touch('btn-jump','j'); touch('btn-fire','f');
    }

    fire() {
        if(!this.active) return;
        if(!this.bullets) this.bullets = [];
        this.bullets.push({x:this.player.x + (this.player.face*20), y:this.player.y-40, vx:this.player.face*12, life:100});
        SFX.play(400, 'square');
    }
}

// --- GLOBAL Y√ñNETƒ∞M ---
let g;
let cl = 0;

function selLvl(i) { 
    cl=i; 
    document.querySelectorAll('.level-btn').forEach((b,k)=>b.classList.toggle('selected',k===i)); 
}

function startGame() { 
    if(!g) g=new Game(); 
    g.start(cl); 
}

// Yeni Seviye Ge√ßi≈ü Mantƒ±ƒüƒ±
function handleLevelComplete() {
    const nextLvl = cl + 1;
    const overlay = document.getElementById('overlay');
    const title = document.getElementById('menu-title');
    const desc = document.getElementById('menu-desc');
    const grid = document.getElementById('level-selection');
    const btn = document.getElementById('main-action-btn');

    overlay.classList.remove('hidden');
    
    if (nextLvl < LEVELS.length) {
        title.innerText = "B√ñL√úM Bƒ∞TTƒ∞! üéâ";
        title.style.color = "#66BB6A";
        desc.innerText = "Harika i≈ü √ßƒ±kardƒ±n!";
        grid.style.display = 'none'; // Grid'i gizle
        btn.innerText = "SONRAKƒ∞ SEVƒ∞YE ‚ñ∂";
        btn.style.background = "#4CAF50";
        // Butona yeni fonksiyon ata
        btn.onclick = () => {
            cl = nextLvl;
            g.start(cl);
            // Men√º yapƒ±sƒ±nƒ± eski haline getir (sonraki reset i√ßin)
            setTimeout(resetMenuUI, 500); 
        };
    } else {
        title.innerText = "OYUN Bƒ∞TTƒ∞! üèÜ";
        desc.innerText = "T√ºm b√∂l√ºmleri tamamladƒ±n!";
        grid.style.display = 'none';
        btn.innerText = "BA≈ûA D√ñN ‚Ü∫";
        btn.onclick = () => {
            location.reload();
        };
    }
}

function resetMenuUI() {
    // Men√ºy√º ba≈ülangƒ±√ß haline d√∂nd√ºr
    const grid = document.getElementById('level-selection');
    const title = document.getElementById('menu-title');
    const desc = document.getElementById('menu-desc');
    const btn = document.getElementById('main-action-btn');
    
    grid.style.display = 'grid';
    title.innerText = "S√úPER KAHRAMANLAR";
    title.style.color = "#FFCA28";
    desc.innerText = "Hangi harfleri √ßalƒ±≈üalƒ±m?";
    btn.innerText = "OYUNA BA≈ûLA üöÄ";
    btn.style.background = "#FF7043";
    btn.onclick = startGame;
}

function openShop() { 
    if(!g) g=new Game(); 
    document.getElementById('shop-modal').style.display='flex';
    document.getElementById('shop-balance').innerText = g.data.sc;
    const grid = document.getElementById('shop-items'); grid.innerHTML='';
    HEROES.forEach(h => {
        const d = document.createElement('div'); d.className='shop-item';
        if(g.data.unl.includes(h.id)) d.classList.add('owned');
        if(g.data.cur === h.id) d.classList.add('equipped');
        d.innerHTML = `<div style="width:40px;height:40px;background:${h.color};border-radius:50%;margin-bottom:5px;"></div><b>${h.name}</b><small>${g.data.unl.includes(h.id)?'':'‚≠ê'+h.price}</small>`;
        d.onclick = () => {
            if(g.data.unl.includes(h.id)) g.data.cur = h.id;
            else if(g.data.sc >= h.price) { g.data.sc-=h.price; g.data.unl.push(h.id); g.data.cur=h.id; }
            g.save(); openShop();
        };
        grid.appendChild(d);
    });
}
function closeShop() { document.getElementById('shop-modal').style.display='none'; }
function speakQuestion() { 
    if(window.speechSynthesis) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(document.getElementById('question-text').innerText);
        u.rate = 0.8; window.speechSynthesis.speak(u);
    }
}
window.onload = () => { if(!g) g=new Game(); };
</script>
</body>
</html>

